<%# Renders a single message, used for both initial load and Turbo Streams %>
<%# Use Turbo Frame for potential targeted updates later, and required by streaming approach %>
<%= turbo_frame_tag message do %>
  <%# Basic styling based on role %>
  <% role_class = case message.role
                  when "user"
                    "bg-blue-700 text-blue-100 self-end ml-10" # User messages on the right
                  when "assistant"
                    "bg-gray-700 text-gray-100 self-start mr-10" # Assistant messages on the left
                  when "system"
                    "bg-gray-700 text-gray-300 text-xs italic mx-auto my-2" # System messages centered/subtle
                  when "tool"
                     "bg-yellow-700 text-yellow-100 text-xs italic self-start mr-10" # Tool results distinct
                  else
                    "bg-gray-700 text-gray-200 self-start mr-10"
                  end
  %>
  <div class="message <%= message.role %> <%= role_class %> rounded-lg p-3 shadow-sm max-w-xl">
    <% unless message.system? %> <%# Don't show role label for system messages %>
       <strong class="block text-sm capitalize mb-1 text-gray-300">
        <%= message.role == 'assistant' ? 'ðŸ¤– Assistant' : (message.role == 'user' ? 'ðŸ‘¤ You' : message.role.capitalize) %>:
      </strong>
    <% end %>

    <%# The crucial div for streaming content. ID MUST match the broadcast target %>
    <%# Use simple_format for basic line breaks, or consider a Markdown renderer gem %>
    <!--
      <div id="<%= dom_id(message, :content) %>" class="message-content prose lg:prose-xl prose-sm max-w-none">
        [lg:prose-xl] <%= markdown_to_html(message.content) %>
      </div>
    -->

    <div id="<%= dom_id(message, :content) %>" class="prose prose-sm max-w-none break-words text-gray-100">
      <%# Render initial content. Streaming will append here. %>
      <%#= simple_format(message.content) %>
      <%= markdown_to_html(message.content) %>
    </div>
  </div>
<% end %>

<%# Ensure the message partial itself doesn't add extra outer divs if already inside #messages container %>
